<!--
    CIC - Forgot Password
    Author: Smarsher.com group
    Date: 2025-12-21
    Version: 1.0.0
    Description: Password reset page with phone verification
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title data-translate="forgot password">CIC - Forgot Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/auth-styles.css">
  <script src="js/api-config.js?v=debug"></script>
  <script src="js/cic-settings-manager.js"></script>
  <script src="js/cic-settings-init.js"></script>
  <style>
    /* Multi-step form styles */
    .step {
      display: none;
      animation: fadeIn 0.4s ease-in;
    }

    .step.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 2rem 0;
      padding: 0 20px;
    }

    .step-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: rgba(0, 255, 136, 0.3);
      transition: all 0.4s ease;
      position: relative;
    }

    .step-dot.active {
      background: var(--luminous-green);
      box-shadow: 0 0 15px var(--luminous-green-glow);
      transform: scale(1.3);
    }

    .step-dot.completed {
      background: var(--luminous-green);
      box-shadow: 0 0 10px var(--luminous-green-glow);
    }

    .step-dot.completed::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--dark-bg);
      font-size: 10px;
      font-weight: bold;
    }

    .code-input-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .code-input {
      width: 55px;
      height: 65px;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      border: 2px solid rgba(0, 255, 136, 0.3);
      background: rgba(42, 42, 42, 0.9);
      color: var(--text-primary);
      border-radius: 15px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .code-input:focus {
      outline: none;
      border-color: var(--luminous-green);
      box-shadow: 0 0 25px var(--luminous-green-glow);
      background: rgba(42, 42, 42, 1);
      transform: scale(1.05);
    }

    .code-label {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }

    .resend-code {
      text-align: center;
      margin-top: 1.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .resend-code a {
      color: var(--luminous-green);
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .resend-code a:hover {
      text-decoration: underline;
      color: var(--luminous-green-light);
    }

    .countdown {
      color: var(--luminous-green);
      font-weight: bold;
    }

    .success-message {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--luminous-green);
    }

    .success-icon {
      font-size: 5rem;
      margin-bottom: 1.5rem;
      animation: successPulse 1s ease-in-out;
    }

    @keyframes successPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .success-message h2 {
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    .success-message p {
      color: var(--text-secondary);
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    .back-link {
      display: inline-block;
      margin-top: 1rem;
      color: var(--luminous-green);
      text-decoration: none;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .back-link:hover {
      color: var(--luminous-green-light);
      text-decoration: underline;
    }

    @media (max-width: 480px) {
      .code-input {
        width: 45px;
        height: 55px;
        font-size: 1.5rem;
      }

      .code-input-group {
        gap: 8px;
      }
    }
  </style>
</head>

<body>
  <!-- Floating Particles -->
  <div class="floating-particles">
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
  </div>

  <div class="auth-container">
    <div class="auth-header">
      <div class="auth-logo">
        <img src="assets/icons/icon-192.png" alt="CIC Logo"
          style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
      </div>
      <div class="auth-title-section">
        <h1 class="auth-title" data-translate="reset password">Reset Password</h1>
        <p class="auth-subtitle" data-translate="reset password">Recover your account</p>
      </div>
      <div id="notification" class="notification" style="display: none;"></div>
    </div>

    <div class="auth-form-container">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step-dot active" id="step1-dot"></div>
        <div class="step-dot" id="step2-dot"></div>
        <div class="step-dot" id="step3-dot"></div>
      </div>

      <!-- Step 1: Enter Email Address -->
      <div class="step active" id="step1">
        <form id="email-form" class="auth-form">
          <div class="form-group">
            <div class="input-group">
              <span class="input-icon">üìß</span>
              <input type="email" id="email" name="email" class="form-input" placeholder="Enter your email address"
                data-translate-placeholder="enter-email" required autocomplete="email">
            </div>
            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block; font-size: 0.85rem;"
              data-translate="forgot-email-tip">
              ‚ö†Ô∏è Use the same email address you bound in your payment details
            </small>
          </div>

          <button type="submit" class="auth-btn" id="send-code-btn">
            <span class="button-text" data-translate="send-verification-code">Send Verification Code</span>
            <span class="button-loader" style="display: none;" data-translate="sending">‚è≥ Sending...</span>
          </button>

          <div class="auth-link">
            <a href="index.html" class="back-link" data-translate="back-to-login-arrow">‚Üê Back to Login</a>
          </div>
        </form>
      </div>

      <!-- Step 2: Enter Verification Code -->
      <div class="step" id="step2">
        <form id="code-form" class="auth-form">
          <div class="form-group">
            <label class="code-label" data-translate="enter-verification-code-label">Enter the 6-digit code sent to your
              email</label>
            <div class="code-input-group">
              <input type="text" class="code-input" maxlength="1" pattern="[0-9]" id="code1" required
                autocomplete="off">
              <input type="text" class="code-input" maxlength="1" pattern="[0-9]" id="code2" required
                autocomplete="off">
              <input type="text" class="code-input" maxlength="1" pattern="[0-9]" id="code3" required
                autocomplete="off">
              <input type="text" class="code-input" maxlength="1" pattern="[0-9]" id="code4" required
                autocomplete="off">
              <input type="text" class="code-input" maxlength="1" pattern="[0-9]" id="code5" required
                autocomplete="off">
              <input type="text" class="code-input" maxlength="1" pattern="[0-9]" id="code6" required
                autocomplete="off">
            </div>
          </div>

          <button type="submit" class="auth-btn" id="verify-code-btn">
            <span class="button-text" data-translate="verify-code">Verify Code</span>
            <span class="button-loader" style="display: none;" data-translate="verifying">‚è≥ Verifying...</span>
          </button>

          <div class="resend-code">
            <span data-translate="no-code-received">Didn't receive the code? </span>
            <a href="#" id="resend-link" data-translate="resend">Resend</a>
            <span id="countdown-text" class="countdown" style="display: none;"></span>
          </div>

          <div class="auth-link">
            <a href="#" id="back-to-email" class="back-link" data-translate="change-email-address">‚Üê Change Email
              Address</a>
          </div>
        </form>
      </div>

      <!-- Step 3: Enter New Password -->
      <div class="step" id="step3">
        <form id="password-form" class="auth-form">
          <div class="form-group">
            <div class="input-group">
              <span class="input-icon">üîí</span>
              <input type="password" id="new-password" name="new-password" class="form-input"
                placeholder="Enter new password" data-translate-placeholder="enter-new-password" required minlength="6"
                autocomplete="new-password">
              <button type="button" class="password-toggle" onclick="togglePassword('new-password', this)">üëÅ</button>
            </div>
            <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;"
              data-translate="password-min-length">
              Must be at least 6 characters
            </small>
          </div>

          <div class="form-group">
            <div class="input-group">
              <span class="input-icon">üîí</span>
              <input type="password" id="confirm-password" name="confirm-password" class="form-input"
                placeholder="Confirm new password" data-translate-placeholder="confirm-new-password" required
                minlength="6" autocomplete="new-password">
              <button type="button" class="password-toggle"
                onclick="togglePassword('confirm-password', this)">üëÅ</button>
            </div>
          </div>

          <button type="submit" class="auth-btn" id="reset-password-btn">
            <span class="button-text" data-translate="reset-password-button">Reset Password</span>
            <span class="button-loader" style="display: none;" data-translate="resetting">‚è≥ Resetting...</span>
          </button>

          <div class="auth-link">
            <a href="#" id="back-to-code" class="back-link" data-translate="back-to-code">‚Üê Back to Code</a>
          </div>
        </form>
      </div>

      <!-- Success Message -->
      <div class="step" id="step4">
        <div class="success-message">
          <div class="success-icon">‚úÖ</div>
          <h2 data-translate="reset-successful-title">Password Reset Successful!</h2>
          <p data-translate="reset-successful-msg">Your password has been reset successfully.<br>You can now login with
            your new password.</p>
          <a href="index.html" class="auth-btn"
            style="display: inline-block; margin-top: 1.5rem; text-decoration: none;" data-translate="go-to-login">
            Go to Login
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentStep = 1;
    let userEmail = '';
    let verificationCode = '';
    let countdownTimer = null;
    let countdownSeconds = 60;

    // API Configuration
    const API_URL = window.API_CONFIG ? window.API_CONFIG.getUrl('auth') : 'https://cicagency.onrender.com/api/auth';

    // Toggle password visibility
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅ';
      }
    }

    // Step navigation
    function showStep(step) {
      // Hide all steps
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step-dot').forEach(d => {
        d.classList.remove('active');
        const stepNum = parseInt(d.id.replace('step', '').replace('-dot', ''));
        if (stepNum < step) {
          d.classList.add('completed');
        } else {
          d.classList.remove('completed');
        }
      });

      // Show current step
      const stepElement = document.getElementById(`step${step}`);
      if (stepElement) {
        stepElement.classList.add('active');
      }
      const dotElement = document.getElementById(`step${step}-dot`);
      if (dotElement) {
        dotElement.classList.add('active');
      }
      currentStep = step;
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.style.display = 'block';

      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // Set button loading state
    function setButtonLoading(buttonId, loading) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      const text = button.querySelector('.button-text');
      const loader = button.querySelector('.button-loader');

      if (loading) {
        button.disabled = true;
        if (text) text.style.display = 'none';
        if (loader) loader.style.display = 'inline';
      } else {
        button.disabled = false;
        if (text) text.style.display = 'inline';
        if (loader) loader.style.display = 'none';
      }
    }

    // Start countdown timer
    function startCountdown() {
      countdownSeconds = 60;
      const countdownText = document.getElementById('countdown-text');
      const resendLink = document.getElementById('resend-link');

      if (resendLink) resendLink.style.display = 'none';
      if (countdownText) {
        countdownText.style.display = 'inline';
        countdownText.textContent = `Resend in ${countdownSeconds}s`;
      }

      if (countdownTimer) clearInterval(countdownTimer);

      countdownTimer = setInterval(() => {
        countdownSeconds--;
        if (countdownText) {
          countdownText.textContent = `Resend in ${countdownSeconds}s`;
        }

        if (countdownSeconds <= 0) {
          clearInterval(countdownTimer);
          if (resendLink) resendLink.style.display = 'inline';
          if (countdownText) countdownText.style.display = 'none';
        }
      }, 1000);
    }

    // Auto-focus next code input
    function setupCodeInputs() {
      const codeInputs = document.querySelectorAll('.code-input');
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          if (e.target.value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        // Paste support
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text').trim();
          if (/^\d{6}$/.test(pastedData)) {
            pastedData.split('').forEach((digit, i) => {
              if (codeInputs[i]) {
                codeInputs[i].value = digit;
              }
            });
            codeInputs[5].focus();
          }
        });
      });
    }

    // Step 1: Request verification code
    document.getElementById('email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();

      if (!email) {
        showNotification('Please enter your email address', 'error');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification('Please enter a valid email address', 'error');
        return;
      }

      userEmail = email;
      setButtonLoading('send-code-btn', true);

      try {
        const response = await fetch(`${API_URL}/forgot-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (data.success) {
          showNotification('Verification code sent to your email. Please check your inbox.', 'success');
          setButtonLoading('send-code-btn', false);
          showStep(2);
          startCountdown();
          setTimeout(() => {
            document.getElementById('code1').focus();
          }, 300);

          // Never display code to user - only log in console for debugging
          if (data.code) {
            console.log('üîê Verification Code (console only):', data.code);
          }
        } else {
          setButtonLoading('send-code-btn', false);
          showNotification(data.error || 'Failed to send verification code. Please check your email configuration.', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        setButtonLoading('send-code-btn', false);
        showNotification('Network error. Please check your connection and try again.', 'error');
      }
    });

    // Step 2: Verify code
    document.getElementById('code-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const codeInputs = document.querySelectorAll('.code-input');
      const code = Array.from(codeInputs).map(input => input.value).join('');

      if (code.length !== 6) {
        showNotification('Please enter the complete 6-digit code', 'error');
        return;
      }

      verificationCode = code;
      setButtonLoading('verify-code-btn', true);

      try {
        const response = await fetch(`${API_URL}/verify-reset-code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: userEmail, code })
        });

        const data = await response.json();

        if (data.success && data.verified) {
          showNotification('Code verified successfully', 'success');
          showStep(3);
        } else {
          showNotification(data.error || 'Invalid verification code', 'error');
          // Clear code inputs
          codeInputs.forEach(input => input.value = '');
          codeInputs[0].focus();
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'error');
      } finally {
        setButtonLoading('verify-code-btn', false);
      }
    });

    // Step 3: Reset password
    document.getElementById('password-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword.length < 6) {
        showNotification('Password must be at least 6 characters', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
      }

      setButtonLoading('reset-password-btn', true);

      try {
        const response = await fetch(`${API_URL}/reset-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: userEmail,
            code: verificationCode,
            newPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          showStep(4); // Success step
        } else {
          showNotification(data.error || 'Failed to reset password', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'error');
      } finally {
        setButtonLoading('reset-password-btn', false);
      }
    });

    // Resend code
    document.getElementById('resend-link').addEventListener('click', async (e) => {
      e.preventDefault();
      if (countdownSeconds > 0) return;

      setButtonLoading('send-code-btn', true);

      try {
        const response = await fetch(`${API_URL}/forgot-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: userEmail })
        });

        const data = await response.json();

        if (data.success) {
          showNotification('New verification code sent', 'success');
          startCountdown();

          // Clear code inputs
          document.querySelectorAll('.code-input').forEach(input => {
            input.value = '';
          });
          document.getElementById('code1').focus();

          // Never display code to user - only log in console for debugging
          if (data.code) {
            console.log('üîê New Verification Code (console only):', data.code);
          }
        } else {
          showNotification(data.error || 'Failed to resend code', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Network error. Please try again.', 'error');
      } finally {
        setButtonLoading('send-code-btn', false);
      }
    });

    // Back navigation
    document.getElementById('back-to-email').addEventListener('click', (e) => {
      e.preventDefault();
      showStep(1);
      clearInterval(countdownTimer);
    });

    document.getElementById('back-to-code').addEventListener('click', (e) => {
      e.preventDefault();
      showStep(2);
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupCodeInputs();
    });
  </script>
</body>

</html>