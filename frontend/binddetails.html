<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title data-translate="bind-details-title">Bind Payment Details - CIC</title>

  <!-- Monarch Design System -->
  <link rel="stylesheet" href="css/monarch-design-system.css">
  <script src="js/api-config.js"></script>
  <script src="js/cic-settings-manager.js"></script>
  <script src="js/cic-settings-init.js"></script>
  <style>
    :root {
      --brand-green: #00ff88;
      --brand-maroon: #8b4513;
      --brand-dark: #006633;
      --brand-accent: #32ff7e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      background: var(--brand-green);
      padding: 20px;
      color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-title {
      flex: 1;
      font-size: 24px;
      font-weight: 700;
    }

    /* Content */
    .content {
      flex: 1;
      padding: 20px;
    }

    /* Info Box */
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .info-box-title {
      font-size: 14px;
      font-weight: 700;
      color: #1565c0;
      margin-bottom: 8px;
    }

    .info-box-text {
      font-size: 13px;
      color: #1976d2;
      line-height: 1.5;
    }

    /* Form Section */
    .form-section {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    .form-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      outline: none;
      transition: border-color 0.3s;
      background: white;
    }

    .form-input:focus,
    .form-select:focus {
      border-color: var(--brand-green);
    }

    .form-select {
      cursor: pointer;
    }

    .save-btn {
      width: 100%;
      background: var(--brand-green);
      color: white;
      border: none;
      padding: 16px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .save-btn:hover {
      background: var(--brand-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
    }

    /* Current Details Card */
    .current-details {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    .current-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 16px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-size: 14px;
      color: #666;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--brand-green);
      padding: 8px 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.3s;
      padding: 8px 12px;
      border-radius: 8px;
    }

    .nav-item:hover,
    .nav-item.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .nav-icon {
      font-size: 24px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 32px 24px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .modal-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
    }

    .modal-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 24px;
    }

    .modal-btn {
      background: var(--brand-green);
      color: white;
      border: none;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button class="back-btn" onclick="window.history.back()">‚Üê</button>
      <h1 class="header-title" data-translate="bind-details-header">Bind Payment Details</h1>
    </div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Info Box -->
    <div class="info-box">
      <div class="info-box-title" data-translate="important-info">‚ÑπÔ∏è Important</div>
      <div class="info-box-text" data-translate="important-info-desc">
        Please provide accurate payment details for withdrawals. Make sure the information matches your account to avoid
        processing delays.
      </div>
    </div>

    <!-- Current Details -->
    <div class="current-details" id="current-details" style="display: none;">
      <div class="current-title" data-translate="current-payment-details">Current Payment Details</div>
      <div class="detail-row">
        <span class="detail-label" data-translate="payment-method">Payment Method</span>
        <span class="detail-value" id="current-method">---</span>
      </div>
      <div class="detail-row">
        <span class="detail-label" data-translate="account-number">Account Number</span>
        <span class="detail-value" id="current-account">---</span>
      </div>
      <div class="detail-row">
        <span class="detail-label" data-translate="account-name">Account Name</span>
        <span class="detail-value" id="current-name">---</span>
      </div>
      <div class="detail-row">
        <span class="detail-label" data-translate="email-address">Email Address</span>
        <span class="detail-value" id="current-email">---</span>
      </div>
    </div>

    <!-- Bind Form -->
    <div class="form-section">
      <div class="form-title" data-translate="add-update-payment-details">Add/Update Payment Details</div>

      <div class="form-group">
        <label class="form-label" data-translate="payment-method">Payment Method</label>
        <select class="form-select" id="payment-method">
          <option value="" data-translate="select-method">Select method</option>
          <option value="mpesa">M-Pesa</option>
          <option value="bank">Bank Transfer</option>
          <option value="airtel">Airtel Money</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" data-translate="account-phone-number">Account Number / Phone Number</label>
        <input type="text" class="form-input" id="account-number" placeholder="e.g., 0712345678"
          data-translate-placeholder="enter-account-number">
      </div>

      <div class="form-group">
        <label class="form-label" data-translate="account-name">Account Name</label>
        <input type="text" class="form-input" id="account-name" placeholder="Your full name"
          data-translate-placeholder="enter-full-name">
      </div>

      <div class="form-group" id="bank-name-group" style="display: none;">
        <label class="form-label" data-translate="bank-name">Bank Name</label>
        <select class="form-select" id="bank-name">
          <option value="" data-translate="select-bank">Select bank</option>
          <option value="Equity Bank">Equity Bank</option>
          <option value="KCB">KCB (Kenya Commercial Bank)</option>
          <option value="Co-operative Bank">Co-operative Bank</option>
          <option value="Barclays Bank">Absa Bank (Barclays)</option>
          <option value="Standard Chartered">Standard Chartered</option>
          <option value="Stanbic Bank">Stanbic Bank</option>
          <option value="I&M Bank">I&M Bank</option>
          <option value="DTB">Diamond Trust Bank (DTB)</option>
          <option value="Family Bank">Family Bank</option>
          <option value="NCBA">NCBA Bank</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label"><span data-translate="email-address">Email Address</span> <span
            style="color: #ff6b6b;">*</span></label>
        <input type="email" class="form-input" id="email" placeholder="your.email@gmail.com" required
          data-translate-placeholder="enter-email">
        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;"
          data-translate="email-verification-note">
          üìß This email will be used for password reset verification. Make sure to use a valid Gmail address.
        </small>
      </div>

      <button class="save-btn" onclick="savePaymentDetails()" data-translate="save-payment-details">Save Payment
        Details</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="home.html" class="nav-item">
      <span class="nav-icon">üè†</span>
      <span data-translate="home">Home</span>
    </a>
    <a href="task.html" class="nav-item">
      <span class="nav-icon">üìã</span>
      <span data-translate="tasks">Tasks</span>
    </a>
    <a href="invest.html" class="nav-item">
      <span class="nav-icon">üí∞</span>
      <span data-translate="invest">Invest</span>
    </a>
    <a href="withdrawal.html" class="nav-item">
      <span class="nav-icon">üí∏</span>
      <span data-translate="withdraw">Withdraw</span>
    </a>
    <a href="profile.html" class="nav-item">
      <span class="nav-icon">üë§</span>
      <span data-translate="profile">Profile</span>
    </a>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-icon" id="modal-icon">‚úÖ</div>
      <div class="modal-title" id="modal-title" data-translate="success">Success</div>
      <div class="modal-message" id="modal-message" data-translate="details-saved-success">Details saved successfully
      </div>
      <button class="modal-btn" onclick="closeModal()" data-translate="ok">OK</button>
    </div>
  </div>

  <script>
    // Show/hide bank name field based on payment method
    document.getElementById('payment-method').addEventListener('change', function () {
      const bankGroup = document.getElementById('bank-name-group');
      if (this.value === 'bank') {
        bankGroup.style.display = 'block';
      } else {
        bankGroup.style.display = 'none';
      }
    });

    // Load current details
    function loadCurrentDetails() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'index.html';
        return;
      }

      const apiUrl = window.API_CONFIG ? window.API_CONFIG.getUrl('auth/payment-details') : 'https://cicagency.onrender.com/api/auth/payment-details';
      fetch(apiUrl, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(res => res.json())
        .then(data => {
          if (data.success && data.details) {
            document.getElementById('current-details').style.display = 'block';
            document.getElementById('current-method').textContent = data.details.method || '---';
            document.getElementById('current-account').textContent = data.details.account_number || '---';
            document.getElementById('current-name').textContent = data.details.account_name || '---';
            document.getElementById('current-email').textContent = data.details.email || '---';

            // Pre-fill form with existing data
            if (data.details.email) {
              document.getElementById('email').value = data.details.email;
            }
          }
        })
        .catch(err => console.error('Error loading details:', err));
    }

    // Save payment details
    function savePaymentDetails() {
      const method = document.getElementById('payment-method').value;
      const accountNumber = document.getElementById('account-number').value;
      const accountName = document.getElementById('account-name').value;
      const bankName = document.getElementById('bank-name').value;
      const email = document.getElementById('email').value.trim();

      // Validation
      if (!method) {
        showModal('‚ùå', 'Error', 'Please select a payment method');
        return;
      }

      if (!accountNumber) {
        showModal('‚ùå', 'Error', 'Please enter your account number');
        return;
      }

      if (!accountName) {
        showModal('‚ùå', 'Error', 'Please enter your account name');
        return;
      }

      if (method === 'bank' && !bankName) {
        showModal('‚ùå', 'Error', 'Please select your bank');
        return;
      }

      if (!email) {
        showModal('‚ùå', 'Error', 'Please enter your email address');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showModal('‚ùå', 'Error', 'Please enter a valid email address');
        return;
      }

      const token = localStorage.getItem('token');
      const apiUrl = window.API_CONFIG ? window.API_CONFIG.getUrl('auth/payment-details') : 'https://cicagency.onrender.com/api/auth/payment-details';

      // Submit to API
      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          method: method,
          account_number: accountNumber,
          account_name: accountName,
          bank_name: method === 'bank' ? bankName : null,
          email: email
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showModal('‚úÖ', 'Success!', 'Your payment details have been saved successfully.');

            // Clear form
            document.getElementById('payment-method').value = '';
            document.getElementById('account-number').value = '';
            document.getElementById('account-name').value = '';
            document.getElementById('bank-name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('bank-name-group').style.display = 'none';

            // Reload current details
            loadCurrentDetails();
          } else {
            showModal('‚ùå', 'Error', data.error || 'Failed to save details');
          }
        })
        .catch(err => {
          console.error('Error:', err);
          showModal('‚ùå', 'Error', 'Failed to save payment details');
        });
    }

    function showModal(icon, title, message) {
      document.getElementById('modal-icon').textContent = icon;
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').textContent = message;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      loadCurrentDetails();
    });
  </script>
</body>

</html>