<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="payment-portal-title">M-Pesa Payment Portal</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="js/api-config.js"></script>
    <script src="js/cic-settings-manager.js"></script>
    <script src="js/cic-settings-init.js"></script>
</head>

<body>
    <div class="container">
        <div class="payment-card">
            <div class="header">
                <div class="logo">
                    <i class="fas fa-building"></i>
                    <span>CIC GROUP</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span data-translate="secure-payment">Secure Payment</span>
                </div>
            </div>

            <div class="payment-form">
                <button type="button" class="pay-button"
                    style="background: #1a1a1a; margin-bottom: 2rem; margin-top: 0;"
                    onclick="window.location.href='recharge-method-2.html'">
                    <span class="button-text">Recharge Method 2 (Manual)</span>
                    <i class="fas fa-wallet"></i>
                </button>

                <h2 data-translate="complete-payment">Complete Your Payment</h2>
                <p class="subtitle" data-translate="pay-securely-desc">Pay securely with M-Pesa mobile money</p>

                <form id="paymentForm">
                    <div class="form-group">
                        <label for="amount" data-translate="amount-kes">Amount (KES)</label>
                        <div class="amount-input">
                            <span class="currency">KES</span>
                            <input type="number" id="amount" name="amount" placeholder="0" step="1" min="1" required>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label for="phoneNumber" data-translate="mpesa-phone-number">M-Pesa Phone Number</label>
                        <div class="phone-input">
                            <span class="country-code">+254</span>
                            <input type="tel" id="phoneNumber" name="phoneNumber"
                                placeholder="+254712345678 or 0712345678" maxlength="15" required>
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <small class="help-text" data-translate="phone-help-text">Enter your M-Pesa registered phone
                            number (supports +254, 07, 01 formats)</small>
                    </div>

                    <button type="submit" class="pay-button" id="payButton">
                        <span class="button-text" data-translate="pay-with-mpesa">Pay with M-Pesa</span>
                        <i class="fas fa-mobile-alt"></i>
                    </button>
                </form>
            </div>

            <div class="payment-methods">
                <p data-translate="powered-by">Powered by</p>
                <div class="mpesa-info">
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <span data-translate="instant-payment">Instant Payment</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-shield-alt"></i>
                        <span data-translate="secure-safe">Secure & Safe</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-mobile-alt"></i>
                        <span data-translate="mobile-money">Mobile Money</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- STK Push Status Modal -->
        <div class="stk-modal" id="stkModal">
            <div class="stk-overlay"></div>
            <div class="stk-container">
                <div class="stk-header">
                    <div class="stk-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <h3 data-translate="stk-push-sent">STK Push Sent!</h3>
                    <p data-translate="stk-check-phone">Please check your phone and enter your M-Pesa PIN to complete
                        the payment</p>
                </div>
                <div class="transaction-details">
                    <div class="detail-row">
                        <span data-translate="amount">Amount:</span>
                        <span id="stkAmount">KES 0</span>
                    </div>
                    <div class="detail-row">
                        <span data-translate="phone">Phone:</span>
                        <span id="stkPhone">+254 000000000</span>
                    </div>
                    <div class="detail-row">
                        <span data-translate="status-label">Status:</span>
                        <span id="stkStatus" class="status-pending" data-translate="waiting-pin">Waiting for
                            PIN...</span>
                    </div>
                </div>

                <div class="stk-actions">
                    <button class="cancel-btn" id="cancelStk">Cancel Payment</button>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="success-modal" id="successModal">
            <div class="success-overlay"></div>
            <div class="success-container">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 data-translate="payment-successful">Payment Successful!</h3>
                <p data-translate="payment-processed-msg">Your payment has been processed successfully.</p>
                <div class="transaction-details">
                    <div class="detail-row">
                        <span data-translate="transaction-id-label">Transaction ID:</span>
                        <span id="transactionId">MPESA-123456789</span>
                    </div>
                    <div class="detail-row">
                        <span data-translate="amount">Amount:</span>
                        <span id="paidAmount">KES 0</span>
                    </div>
                    <div class="detail-row">
                        <span data-translate="phone-number">Phone Number:</span>
                        <span id="paidPhone">+254 000000000</span>
                    </div>
                    <div class="detail-row">
                        <span data-translate="date-label">Date:</span>
                        <span id="transactionDate"></span>
                    </div>
                    <div class="detail-row">
                        <span data-translate="status-label">Status:</span>
                        <span class="status-success" data-translate="completed">Completed</span>
                    </div>
                </div>
                <button class="close-btn" id="closeSuccess">Close</button>
            </div>
        </div>

        <!-- Error Modal -->
        <div class="error-modal" id="errorModal">
            <div class="error-overlay"></div>
            <div class="error-container">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 data-translate="payment-failed">Payment Failed</h3>
                <p id="errorMessage" data-translate="payment-error-msg">There was an error processing your payment.
                    Please try again.</p>
                <button class="retry-btn" id="retryPayment" data-translate="try-again">Try Again</button>
            </div>
        </div>
    </div>

    <script src="js/api-config.js"></script>
    <script>
        // Initialize payment form with URL parameters
        document.addEventListener('DOMContentLoaded', function () {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const amountParam = urlParams.get('amount');

            // Pre-fill amount if provided in URL
            if (amountParam) {
                const amountInput = document.getElementById('amount');
                if (amountInput) {
                    const amount = parseFloat(amountParam);
                    if (!isNaN(amount) && amount > 0) {
                        amountInput.value = Math.round(amount);
                        console.log('Pre-filled amount from URL:', amount);
                    }
                }
            }

            // Try to pre-fill phone number from user data if available
            const token = localStorage.getItem('token');
            if (token) {
                // Get user phone from stored data or API
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                if (userInfo.phone) {
                    const phoneInput = document.getElementById('phoneNumber');
                    if (phoneInput && !phoneInput.value) {
                        // Format phone number for display
                        let phone = userInfo.phone;
                        // Remove +254 prefix if present, we'll add it back in the input
                        if (phone.startsWith('+254')) {
                            phone = phone.substring(4);
                        } else if (phone.startsWith('254')) {
                            phone = phone.substring(3);
                        }
                        // Remove leading 0 if present
                        if (phone.startsWith('0')) {
                            phone = phone.substring(1);
                        }
                        phoneInput.value = phone;
                        console.log('Pre-filled phone from user data');
                    }
                } else {
                    // Fetch user data from API
                    fetch(`${API_BASE_URL || ''}/api/auth/stats`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.phone) {
                                const phoneInput = document.getElementById('phoneNumber');
                                if (phoneInput && !phoneInput.value) {
                                    let phone = data.phone;
                                    if (phone.startsWith('+254')) {
                                        phone = phone.substring(4);
                                    } else if (phone.startsWith('254')) {
                                        phone = phone.substring(3);
                                    }
                                    if (phone.startsWith('0')) {
                                        phone = phone.substring(1);
                                    }
                                    phoneInput.value = phone;
                                    console.log('Pre-filled phone from API');
                                }
                            }
                        })
                        .catch(err => {
                            console.log('Could not fetch user phone:', err);
                        });
                }
            }

            // Intercept Pay with M-Pesa button
            const payButton = document.getElementById('payButton');
            if (payButton) {
                const originalOnClick = payButton.onclick;
                payButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const amount = document.getElementById('amount').value;
                    const url = amount ? `recharge-method-2.html?amount=${amount}` : 'recharge-method-2.html';

                    alert('We have an authenticating problem with STK push, but our team is doing everything to manage it. You will be redirected to our alternative recharge method.');
                    window.location.href = url;
                }, true);
            }
        });
    </script>
    <script src="assets/js/app.js"></script>
</body>

</html>